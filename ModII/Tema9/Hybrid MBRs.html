<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<HTML><HEAD>
<TITLE>Hybrid MBRs</TITLE>
  <link href="../Styles/styles.css" rel="stylesheet" type="text/css" />
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<meta name="viewport" content="width=device-width, initial-scale=1">

<H1 ALIGN="CENTER"><CENTER>Hybrid MBRs: The Good, the Bad, and the So Ugly
You'll Tear Your Eyes Out</CENTER></H1>

<H2 ALIGN="CENTER"><CENTER>by Rod Smith, <a
href="mailto:rodsmith@rodsbooks.com">rodsmith@rodsbooks.com</a></CENTER></H2>

<p>Last Web page update: 2/1/2019, referencing GPT fdisk version 1.0.4</p>

<p>I'm a technical writer and consultant specializing in Linux technologies. This Web page, and the associated software, is provided free of charge and with no annoying outside ads; however, I did take time to prepare it, and Web hosting does cost money. If you find GPT fdisk or this Web page useful, please consider making a small donation to help keep this site up and running. Thanks!</p>

<table border="1">
<tr>
<td>Donate $1.00</td>
<td>Donate $2.50</td>
<td>Donate $5.00</td>
<td>Donate $10.00</td>
<td>Donate $20.00</td>
<td>Donate another value</td>
</tr>
<tr>

<td>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post">
<input type="hidden" name="cmd" value="_donations">
<input type="hidden" name="business" value="rodsmith@rodsbooks.com">
<input type="hidden" name="lc" value="US">
<input type="hidden" name="no_note" value="0">
<input type="hidden" name="currency_code" value="USD">
<input type="hidden" name="amount" value="1.00">
<input type="hidden" name="item_name" value="GPT fdisk">
<input type="hidden" name="bn" value="PP-DonationsBF:btn_donate_LG.gif:NonHostedGuest">
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
<img alt="Donate with PayPal" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
</form>
</td>

<td>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post">
<input type="hidden" name="cmd" value="_donations">
<input type="hidden" name="business" value="rodsmith@rodsbooks.com">
<input type="hidden" name="lc" value="US">
<input type="hidden" name="no_note" value="0">
<input type="hidden" name="currency_code" value="USD">
<input type="hidden" name="amount" value="2.50">
<input type="hidden" name="item_name" value="GPT fdisk">
<input type="hidden" name="bn" value="PP-DonationsBF:btn_donate_LG.gif:NonHostedGuest">
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
<img alt="Donate with PayPal" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
</form>
</td>


<td>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post">
<input type="hidden" name="cmd" value="_donations">
<input type="hidden" name="business" value="rodsmith@rodsbooks.com">
<input type="hidden" name="lc" value="US">
<input type="hidden" name="no_note" value="0">
<input type="hidden" name="currency_code" value="USD">
<input type="hidden" name="amount" value="5.00">
<input type="hidden" name="item_name" value="GPT fdisk">
<input type="hidden" name="bn" value="PP-DonationsBF:btn_donate_LG.gif:NonHostedGuest">
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
<img alt="Donate with PayPal" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
</form>
</td>

<td>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post">
<input type="hidden" name="cmd" value="_donations">
<input type="hidden" name="business" value="rodsmith@rodsbooks.com">
<input type="hidden" name="lc" value="US">
<input type="hidden" name="no_note" value="0">
<input type="hidden" name="currency_code" value="USD">
<input type="hidden" name="amount" value="10.00">
<input type="hidden" name="item_name" value="GPT fdisk">
<input type="hidden" name="bn" value="PP-DonationsBF:btn_donate_LG.gif:NonHostedGuest">
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
<img alt="Donate with PayPal" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
</form>
</td>

<td>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post">
<input type="hidden" name="cmd" value="_donations">
<input type="hidden" name="business" value="rodsmith@rodsbooks.com">
<input type="hidden" name="lc" value="US">
<input type="hidden" name="no_note" value="0">
<input type="hidden" name="currency_code" value="USD">
<input type="hidden" name="amount" value="20.00">
<input type="hidden" name="item_name" value="GPT fdisk">
<input type="hidden" name="bn" value="PP-DonationsBF:btn_donate_LG.gif:NonHostedGuest">
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
<img alt="Donate with PayPal" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
</form>
</td>

<td>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post">
<input type="hidden" name="cmd" value="_donations">
<input type="hidden" name="business" value="rodsmith@rodsbooks.com">
<input type="hidden" name="lc" value="US">
<input type="hidden" name="no_note" value="0">
<input type="hidden" name="currency_code" value="USD">
<input type="hidden" name="item_name" value="GPT fdisk">
<input type="hidden" name="bn" value="PP-DonationsBF:btn_donate_LG.gif:NonHostedGuest">
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
<img alt="Donate with PayPal" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
</form>
</td></tr>
</table>

<p><b>Note:</b> This page is part of the documentation for my <a
href="index.html">GPT fdisk</a> program.</p>

<p>GPT is a very flexible partitioning scheme with many advantages over the
older MBR system. (For details, see the <a href="whatsgpt.html">What's a
GPT?</a> section of this document.) GPT does have one glaring problem,
though: compatibility. Some OSes, particularly older ones, have limited or
no GPT support. When using such an OS, an ugly, flaky, and downright
dangerous workaround can sometimes be useful: hybrid MBRs. Using a hybrid
MBR, you can satisfy your legacy OS's need for up to three partitions
defined via an MBR, while keeping additional partitions for more
sophisticated OSes in GPT data structures.</p>

<H2 ALIGN="CENTER"><CENTER>Hybrid MBR 101</CENTER></H2>

<p>As noted on other pages in this document, a conventional GPT disk
contains a protective MBR with a single partition, of type 0xEE (EFI GPT),
defined. This partition spans the entire size of the disk or 2 TiB,
whichever is smaller. The intent is to keep GPT-unaware OSes and utilities
from trying to modify the disk.</p>

<p>A hybrid MBR is a variant on the normal protective MBR. A hybrid MBR
contains a type-0xEE partition, but it also contains up to three additional
primary partitions, which point to the same space that's marked out by up to
three GPT partitions. For instance, suppose you've got a Macintosh that
dual-boots macOS and Windows. MacOS is happy on GPT, and so can use GPT
partition definitions; but Windows versions prior to Windows 8 (on Macs) are
less capable in this respect. Thus, you'll define your partitions first as
GPT partitions (including your Windows partitions), and then you'll modify
your protective MBR so that its 0xEE partition is smaller than normal and it
contains one to three partition definitions that point to the same disk
locations as corresponding GPT partitions. You can then install Windows on
these hybridized partitions. Apple's Boot Camp helps automate this process,
so you don't need GPT fdisk to set up a hybrid MBR on a Mac; however, GPT
fdisk can be useful in maintaining your hybrid MBR after it's configured,
and you might want to use it on BIOS-based computers for similar
configurations involving other OSes. On any computer, the end result is that
GPT-unaware OSes can use up to three primary partitions, while GPT-aware
OSes can use all the partitions on the disk.</a>

<p>One important point is that hybrid MBRs are normally needed only on
BIOS-based computers or on those that boot both BIOS-based and EFI-based
OSes. If your system uses EFI, chances are you'll be installing EFI-aware,
and therefore GPT-capable, OSes on it. Windows 7 and later boot from GPT
disks on UEFI-based computers, but Windows 8 or later is required to boot in
this way with Apple's older EFI 1.<i>x</i> implementation. Thus, you'll need
a hybrid MBR on a Mac to install Windows 7 or earlier; but for later
versions of Windows, using a conventional GPT and installing in EFI mode is
generally preferable. In other words, the need for a hybrid MBR is fading.
As described next, this is good, since hybrid MBRs have significant
problems.</p>

<H2 ALIGN="CENTER"><CENTER>Dangers and Problems of a Hybrid MBR</CENTER></H2>

<p>The preceding description makes hybrid MBRs sound great: You get the
best of both MBR and GPT by creating a hybrid MBR. Unfortunately, hybrid
MBRs carry with them a lot of baggage. Some of these problems are mere
annoyances, but other issues are real dangers. They include:</p>

<UL>

<LI>Hybrid MBRs are not part of Intel's EFI GPT standard. Thus, the details
    of how different OSes and utilities interpret them varies considerably.
    Some details follow, in the <a href="#reactions">OSes' Reactions to
    Hybrid MBRs</a> section. Some tools (such as GNU Parted, at least as of
    version 3.2) automatically convert the hybrid MBR to a conventional
    protective MBR, and it's conceivable that some current or future OS
    will react badly, too. Apple's Disk Utility has a bug that causes it to
    fail on disks with hybrid MBRs that contain MBR partition types it
    doesn't understand. There's no telling how some random disk utility
    will react to a hybrid MBR; it's conceivable that something intended to
    rescue your data will end up destroying it. Boot loaders can sometimes
    interpret hybrid MBRs in unhelpful ways, too, as described in the
    upcoming section <a href="#bootloaders">Booting from a Hybrid MBR.</a>

<LI>To the best of my knowledge, no utility will create a hybrid MBR that
    includes logical partitions. In theory, such a tool <em>could</em> be
    created. In fact, if you've read my <a href="mbr2gpt.html">Converting
    to or from GPT<a> page, you may wonder why GPT fdisk can't do the job;
    after all, it can already create logical partitions in a full
    conversion, so why not with a hybrid MBR? The reason, in brief, is that
    doing so would create an even more dangerous, delicate, and
    non-standard system. Because logical partitions place data structures
    in a linked-list fashion outside of the partitions they define, it
    would be easy for GPT fdisk (or other GPT partitioning tools) to create
    GPT partitions that would damage one or more of these entries,
    preventing access to some or all logical partitions. I've decided not
    to open that particular can of worms. Even if I were willing to deal
    with the squirmy creatures, adding this "feature" would mean I'd be
    dumping the worms into the laps of the authors of every OS and utility
    that supports GPT, and I consider that very rude at best. Thus, you're
    limited to the three MBR partitions noted earlier. (That said, you
    <em>can</em> convert an MBR disk to GPT form and then create a hybrid
    MBR setup that hybridizes one or more former logical partitions;
    they'll become primary partitions, from an MBR point of view.) 

<LI>The protective EFI GPT (type 0xEE) MBR partition must normally begin on
    the second sector of the disk, in order to protect the primary GPT data
    structures. If it doesn't, older versions of Linux won't find any
    partitions on the disk, and newer versions interpret the disk as an MBR
    disk. FreeBSD, macOS, and Windows seem to handle this situation better.
    This means that if you want to hybridize the first partition on the
    disk, the EFI GPT partition must be quite small for greatest
    compatibility. As a result, it's likely that at least some of your disk
    space will appear to be unallocated to MBR-only utilities, so part of
    the benefit of the protective EFI GPT partition is lost. An unwary user
    might try to create MBR partitions that re-use some disk space that's
    already in use by GPT-only partitions.

<LI>If you have fewer than three partitions you want to hybridize, you may
    be able to work around the preceding problem by creating an additional
    protective partition; however, you might not be able to protect all the
    GPT-only disk space. Furthermore, if you create additional EFI GPT
    (0xEE) partitions, macOS will treat the disk as an MBR disk rather
    than a GPT disk, so you may be forced to use some other type code to
    protect additional areas of the disk. This could be confusing.

<LI>It's possible for the GPT and MBR partition sets to contradict each
    other. This is most likely to happen when using a GPT-unaware disk
    partitioning tool or a GPT tool that's unaware of hybrid MBRs. In such
    a case, you can easily end up with inconsistencies, in which the
    beginning of an MBR partition points to the middle of a GPT partition
    and vice-versa. GPT fdisk includes features to minimize this risk.
    Specifically, when you delete a GPT partition, any corresponding MBR
    partition is also deleted, and the protective EFI GPT (0xEE) MBR
    partition is expanded to fill the freed space, if this is possible. GPT
    fdisk also checks for GPT/MBR inconsistencies when you perform a
    verification function (<tt>v</tt> on the menu) and before saving data.

<LI>A hybrid MBR doesn't work around the 2 TiB limit for MBR partitions. On
    an over-2 TiB disk, only GPT-aware OSes and utilities will be able to
    use the whole disk; anything that relies on the MBR side will be
    limited to 2 TiB of disk space.

<LI>The MBR and GPT partition numbers might not match. This could be
    confusing in some situations, and if your boot loader is inconsistent
    in its use of the MBR vs. the GPT side of things, it may cause boot
    problems.

<LI>Maintaining a hybrid MBR requires additional code in disk partitioning
    tools, and this creates the opportunity for new bugs to creep in. In the
    past, such bugs have existed in GPT fdisk (although I know of none as of
    version 1.0.4). In the fall and winter of 2010, I saw a lot of problem
    reports from Mac users who attempted to dual-boot with Linux because one
    of the utilities involved created a buggy hybrid MBR with an extra
    type-0xEE partition that overlapped others. (The solution was to delete
    the spare 0xEE partition, which was usually <tt>/dev/sda3</tt> in
    <tt>fdisk</tt>.) These problem reports died down by mid-2011, but the
    fact that they existed at all illustrates the point that hybrid MBRs
    create an opportunity for new bugs to hatch.

</UL>

<p>Overall, hybrid MBRs should be avoided. I've included support for them in
GPT fdisk only because they're used by Apple's Boot Camp to boot Windows 7
and earlier, and because they can be useful in certain other exotic
configurations involving both BIOS-mode and EFI-mode OS installations or
large (over 2TiB) disks on BIOS-based computers in some dual-boot
situations. This fact makes hybrid MBRs a practical necessity in some
environments. Older non-Windows OSes (BeOS, OS/2, DOS, etc.) are likely to
require a hybrid MBR to handle GPT disks, too, although I haven't tested
them explicitly.</p>

<H2 ALIGN="CENTER"><CENTER>Creating a Hybrid MBR</CENTER></H2>

<p class="sidebar">The <tt>gptsync</tt> tool originated with the <a
href="https://sourceforge.net/projects/refit/">rEFIt</a> boot manager for
Macs. My fork of rEFIt, <a
href="https://www.rodsbooks.com/refind/">rEFInd,</a> includes an updated EFI
version of <tt>gptsync</tt> that lifts some of its restrictions. See <a
href="http://www.insanelymac.com/forum/index.php?showtopic=177505">this Web
forum post</a> for an unrelated macOS version of <tt>gptsync</tt> that lifts
some of its restrictions.</p>

<p>If you've read this far, you're presumably interested in creating a
hybrid MBR. In the past, the <tt>gptsync</tt> tool was the only way I knew
of to create hybrid MBRs. This program has certain limitations. For
instance, it blindly converts the first three GPT partitions to MBR form,
and it chokes when it sees partition types it doesn't understand. GPT fdisk is more flexible in both respects, but it
requires more user interaction. Hybrid MBR support was added to GPT fdisk
0.3.2 and to <tt>sgdisk</tt> 0.6.4.</p>

<p>The procedure for creating a hybrid MBR is best illustrated with an
example:</p>

<pre style="margin: 0px; padding: 6px; border: 1px inset; width: 640px;
		text-align: left; background-color:#EEEEEE">
# <b>gdisk /dev/sdc</b>
GPT fdisk (gdisk) version 1.0.4

Partition table scan:
  MBR: protective
  BSD: not present
  APM: not present
  GPT: present

Found valid GPT with protective MBR; using GPT.

Command (? for help): <b>r</b>

recovery/transformation command (? for help): <b>p</b>
Disk /dev/sdc: 15654912 sectors, 7.5 GiB
Model: USB Flash Drive
Sector size (logical/physical): 512/512 bytes
Disk identifier (GUID): E1F3535B-8F5B-1579-E04A-D8DEF36B8302
Partition table holds up to 128 entries
First usable sector is 34, last usable sector is 15654878
Partitions will be aligned on 8-sector boundaries
Total free space is 6 sectors (3.0 KiB)

Number  Start (sector)    End (sector)  Size       Code  Name
   1              40         3072007   1.5 GiB     AF00  Apple HFS/HFS+
   2         3072008         7266311   2.0 GiB     8300  Linux filesystem
   3         7266312        15654878   4.0 GiB     0700  Microsoft basic data

recovery/transformation command (? for help):  
</pre>

<p>The hyrid MBR function is located on the recovery & transformation menu,
so after launching <tt>gdisk</tt>, you should type <tt><b>r</b></tt> to
enter that menu. You'll also need to know partition numbers, so you should
type <tt><b>p</b></tt>, as shown in the example. The example disk (a USB
flash drive) has three partitions, containing HFS, ext2, and FAT
filesystems.</p>

<pre style="margin: 0px; padding: 6px; border: 1px inset; width: 640px;
		text-align: left; background-color:#EEEEEE">
recovery/transformation command (m for help): <b>h</b>

WARNING! Hybrid MBRs are flaky and dangerous! If you decide not to use one,
just hit the Enter key at the below prompt and your MBR partition table will
be untouched.
</pre>

<p>The command to create a hybrid MBR is <tt>h</tt>. Typing that command
causes a warning to be displayed before <tt>gdisk</tt> prompts for
partition information.</p>

<pre style="margin: 0px; padding: 6px; border: 1px inset; width: 640px;
		text-align: left; background-color:#EEEEEE">
Type from one to three GPT partition numbers, separated by spaces, to be
added to the hybrid MBR, in sequence: <b>1 3</b>
Place EFI GPT (0xEE) partition first in MBR (good for GRUB)? (Y/N): <b>y</b>
</pre>

<p>You specify the partitions you want to hybridize by listing their
numbers, separated by spaces. In this example, I've hybridized partitions 1
and 3 (the HFS and FAT partitions). They'll become MBR partitions 1 and 2
or 2 and 3, depending on the answer to the next question.</p>

<p>GPT fdisk can create the EFI GPT (0xEE) placeholder partition either
before or after the hybridized partitions in the MBR table. (Note that this
has nothing to do with the disk sectors this partition protects.) Each
placement has its advantages. Putting the 0xEE partition first in the table
works best with GRUB Legacy and GRUB 2, which treat the disk as an MBR disk
if the first slot in the MBR is not a 0xEE partition. This first-position
placement of 0xEE, however, can render Windows unable to read subsequent
partitions if the disk is a removable disk, such as a USB flash drive.
Overall, if the disk is a hard disk, I recommend putting the 0xEE partition
first; if it's a removable disk, putting it later in the table may work
better.</p>

<pre style="margin: 0px; padding: 6px; border: 1px inset; width: 640px;
		text-align: left; background-color:#EEEEEE">
Creating entry for partition #1
Enter an MBR hex code (default AF): <b>af</b>
Set the bootable flag? (Y/N): <b>n</b>

Creating entry for partition #3
Enter an MBR hex code (default 07): <b>0c</b>
Set the bootable flag? (Y/N): <b>y</b>

Unused partition space(s) found. Use one to protect more partitions? (Y/N): <b>y</b>
Enter an MBR hex code (EE is EFI GPT, but may confuse MacOS): <b>0a</b>
</pre>

<p>The program now prompts you for some information about each partition.
In each case, <tt>gdisk</tt> asks you for an MBR hex code. Although the
program could convert automatically, a single GPT type code (0700 in GPT
fdisk) can map to several different MBR type codes. This fact makes
explicit prompting at this point more sensible than a blind conversion. In
this case, since the second hybridized partition (#3 in GPT) holds a FAT
filesystem, I chose to use a type code of 0x0C. (See <a
href="http://www.win.tue.nl/~aeb/partitions/partition_types-1.html">this
list</a> if you need to find MBR type codes.) You should enter a
two-character hexadecimal value, with or without a leading "0x" indicator,
or press the Enter key to use the default value. You can also set the
bootable flag (aka the active flag) on any or all of your hybridized
partitions; however, this flag is normally set on just one partition.
Ordinarily, you'd set the bootable flag on a Windows boot partition, but
not on data partitions. (At least one boot loader behaves strangely if you
use this flag on Windows, though.) For illustrative purposes, I've set this
flag on one partition.</p>

<p>Because I only hybridized two partitions, there was one unused space in
the partition table, meaning that GPT fdisk could add one more MBR
partition to protect free space from accidental modification. The program
will fill the largest empty (to MBR) space on the disk with the partition
it creates. You're asked if you want to do this, and in this example I
responded in the affirmative. The program then asks for the MBR hex code
for the created partition. Although 0xEE is a logical choice, using it will
cause macOS to interpret the disk as an MBR disk, thus removing the
benefits of GPT for that OS. In this example, I used 0x0A, which is the
code for an OS/2 Boot Manager partition. My reason for using this code is
simply that few disk utilities will attempt to do anything with such a
partition. Many other codes will work as well, but all non-0xEE codes will
be misleading or ambiguous. Note that Apple's Disk Utility has a bug that
renders it unable to manipulate disks with unknown MBR type codes, so you
should be careful with what you select, or simply don't create this extra
partition. In my tests, the 0x0A value worked, but 0x77 (a value I selected
arbitrarily) did not.</p>

<p>One drawback to using a non-0xEE extra protective partition is that
<tt>gdisk</tt>'s own data integrity checks may flag this partition as a
problem. In particular, if the partition spans multiple GPT partitions or
covers an area that doesn't correspond to any GPT partition, <tt>gdisk</tt>
will complain when you save your partitions or perform a disk verification
(via the <tt>v</tt> menu option). If your spare protective partition is of
type 0xEE, though, <tt>gdisk</tt> won't complain. Overall, if you're using
macOS, it may be best to forego this partition. If you use Linux,
FreeBSD, or Windows, but not macOS, I know of no reason not to create an
extra 0xEE partition.</p>

<p>Note that even with the extra protective partition, significant parts of
a disk could go unprotected. In the case of this example, it's just a few
sectors at the end of the disk; however, if you hybridize two
non-contiguous partitions, the last of which is not at the end of the disk,
either the partitions at the end of the disk or the space between the
partitions will be unallocated in an MBR sense. If you hybridize three
partitions, it's likely that even more space will be unallocated in the MBR
scheme. On a sub-2 TiB disk, you can maximize the protected space by
placing the partitions to be hybridized at the <em>end</em> of the disk.
That way, the 0xEE partition will span from the second sector (numbered 1
in partition listings) all the way up to the first hybridized
partition.</p>

<p>Before writing your changes, you should check the status of the hybrid
MBR:</p>

<pre style="margin: 0px; padding: 6px; border: 1px inset; width: 640px;
		text-align: left; background-color:#EEEEEE">
recovery/transformation command (? for help): <b>o</b>
MBR disk identifier: 0x00000000
MBR partitions:
Number  Boot  Start Sector   End Sector   Status      Code
   1                     1           39   primary     0xEE
   2                    40      3071968   primary     0xAF
   3       *       7266312      8388567   primary     0x07
   4               3072008      4194304   primary     0x0A

Disk size is 15654912 sectors (7.5 GiB)
</pre>

<p>Typing <b><tt>o</tt></b> at the recovery & transformation prompt
displays the MBR data, and you can see the hybrid partition definitions.
(<b>Caution:</b> The <tt>o</tt> command, when typed at the main menu,
creates a fresh GPT, including a new protective MBR.) If you compare the
start and end values to the start and end values for the GPT partitions,
you should see that they match for the hybridized partitions. The EFI GPT
(0xEE) partition covers the GPT data structures, and in some cases it can
cover more. If you don't hybridize the partition that comes first in disk
order, the EFI GPT partition will cover its space, for instance. In this
example, the extra 0x0A partition covers the area of the second GPT
partition, since that was the single largest area that was unallocated in
the MBR scheme. In other cases, you might have an MBR partition that spans
multiple GPT partitions or that just covers a bit of unused space at the
end of the disk (protecting the secondary GPT data structures and perhaps
one or more partitions at the end of the disk). If you hybridize only one
GPT partition and choose to create the extra protective partition, GPT
fdisk will be able to protect all the available disk space in the
combination of the regular 0xEE partition, the extra protective partition
you create, and the hybridized partition itself.</p>

<p>If necessary, you can modify the hybrid MBR with Linux's <tt>fdisk</tt>
or other GPT-unaware partitioning tools. (Recent versions of <tt>fdisk</tt>
are GPT-aware. To modify the hybrid MBR with them, include the <tt>-t
dos</tt> flag, as in <tt class="userinput">fdisk -t dos /dev/sdc</tt>.)
GPT-aware programs, however, are likely to modify the GPT side alone, or
perhaps change the hybrid MBR back into a standard protective MBR, as GNU
Parted does, at least through version 3.2. Because GPT doesn't use CHS
addressing, you're likely to find that your partitions don't begin or end on
cylinder boundaries, as viewed by <tt>fdisk</tt> or other MBR tools. This
isn't a problem with modern OSes, but if you need to boot a truly ancient
OS, such as DOS, you may not be able to use even the hybrid MBR
partitions.</p>

<p>Note that the MBR entries may not be in order. In the preceding example,
the entry for the 0x0A partition comes at the end of the table, although
its disk area is between the two real partitions. If you choose to place
the 0xEE partition's entry after the main partitions' entries, the order
can become even more confused. For the most part, these deviations won't
cause problems, although some utilities have specific quirks, as already
noted.</p>

<a name="reactions">
<H2 ALIGN="CENTER"><CENTER>OSes' Reactions to Hybrid MBRs</CENTER></H2>
</a>

<p>In testing hybrid MBRs, I've found that different OSes react to them in
different ways. Further complicating matters, the boot loaders you use to
boot your OSes have their own quirks, as detailed shortly, in <a
href="#bootloaders">Booting from a Hybrid MBR.</a> Unfortunately, these
differences can make use of a hybrid MBR a complex and frustrating task.
OS-by-OS peculiarities include:</p>

<UL>

<LI><b>Linux</b>&mdash;Linux seems to require that at least one 0xEE (EFI
    GPT) partition begin on sector 1 (numbered starting from 0). Linux isn't
    fussy about which partition (1-4) this is, though. In practice, this
    means that if you hybridize the earliest partition on a disk, you'll end
    up with a very short EFI GPT partition, as in the preceding example.
    Note that <tt>gptsync</tt> also starts its 0xEE partition at the
    beginning of the disk, so it creates a Linux-compatible hybrid MBR. If
    you adjust the hybrid MBR with <tt>fdisk</tt> so that the 0xEE partition
    covers a later area of the disk, older versions of Linux become unable
    to find <em>any</em> partitions on the disk. Newer versions of Linux
    will accept the disk, but they'll interpret it as an MBR disk.</LI>

<LI><b>FreeBSD</b>&mdash;My testing of hybrid MBRs with FreeBSD has been
    fairly minimal, and not very recent; however, I do know that FreeBSD
    handles hybrid MBRs created by both <tt>gptsync</tt> and <tt>gdisk</tt>.
    Unlike most OSes, FreeBSD provides access to partitions on a hybrid MBR
    disk using both the MBR and the GPT systems. On a test USB flash drive,
    GPT-style partitions were named <tt>/dev/da0p<em>x</em></tt>, while
    MBR-style partitions were named <tt>/dev/da0s<em>y</em></tt>, where
    <tt><em>x</em></tt> and <tt><em>y</em></tt> are partition numbers. In
    basic tests, FreeBSD 7.1-RELEASE has shown no problems with disks with
    multiple 0xEE MBR partitions (unlike macOS) or with a single 0xEE
    partition that does <em>not</em> begin at the very start of the disk
    (unlike Linux). Thus, overall it appears that FreeBSD may have the best
    hybrid MBR support. I was initially concerned about the possibility of
    data corruption from simultaneous access to the same partition via two
    different <tt>/dev</tt> entries, but I've been assured by a FreeBSD
    developer that the OS prevents such simultaneous access.

<LI><b>macOS</b>&mdash;MacOS can handle just about anything in the way
    of hybrid MBRs, including some configurations (which GPT fdisk doesn't
    create) that give Linux and/or Windows fits. There's one important
    exception, though: More than one partition of type 0xEE causes macOS
    to treat the disk as an MBR disk rather than a GPT disk. This is the
    reason that GPT fdisk prompts you for the type of any additional
    protective partitions, as shown earlier: You may use 0xEE if you don't
    intend to use the disk with macOS, or another code if the disk might
    be accessed by macOS. Although it's not critical to basic macOS
    access to your disks, Disk Utility's problem with unusual MBR partition
    type codes should be kept in mind when creating hybrid MBRs.
    Fortunately, you can easily change a type code if it becomes necessary.

<LI><b>Windows</b>&mdash;When confronted with a hybrid MBR, Windows tries to
    treat the disk as an MBR disk, ignoring the GPT partitions completely.
    This limitation means that in a dual-boot environment, you must
    hybridize <em>all</em> of your Windows partitions, and none of those
    partitions should span the 2 TiB mark on the disk, if the disk is larger
    than that. (You can use GPT with a conventional non-hybridized
    protective MBR on a second physical disk, at least with recent versions
    of Windows.) Windows treats removable disks as "superfloppies," meaning
    they should either not be partitioned or they should have a single
    partition. Thus, if you hybridize a USB flash drive or similar medium,
    you should be sure to put the EFI GPT (0xEE) partition's entry in the
    MBR partition table after the hybridized partitions' entries.
    Furthermore, you should put whatever partition Windows must access first
    in the partition table, by specifying its number first in the list when
    GPT fdisk asks for partition numbers to hybridize. Another important
    Windows issue is setup order: If you install Windows on an MBR disk,
    convert to GPT, and then create a hybrid MBR, it's conceivable that
    Windows will refuse to boot. (This happened to me in my tests.) The
    Windows install disc <em>may</em> be able to restore your system to
    bootability (it couldn't for me), but you may then need to restore any
    non-Microsoft boot loader you're using. It's probably safest to install
    Windows to an already-hybridized disc&mdash;although again, you may then
    need to re-install your multi-OS boot manager. Note that I've done my
    testing on Windows 2000, Windows 7 RC, and Windows 7 on x86 and x86-64
    platforms. I don't know how Windows Me or earlier, or newer versions of
    Windows, will handle things. I also don't know if these rules might be
    different on non-x86/x86-64 platforms. These rules do apply to
    UEFI-booted versions of Windows&mdash;but they understand GPT just fine,
    so there's not likely to be a need to use a hybrid MBR on such a system,
    and in fact doing so can cause Windows to fail to boot!

</UL>

<p>I don't know how other OSes, such as BeOS, OS/2, DOS, Solaris, or
NetBSD, react to hybridized MBRs. If you have problems with such an OS and
the hybrid MBRs created by GPT fdisk, you might want to give
<tt>gptsync</tt> a try. It does things a bit differently, so it's
conceivable that one tool might work better in some environments and the
other will work better in others.</p>

<a name="bootloaders">
<H2 ALIGN="CENTER"><CENTER>Booting from a Hybrid MBR</CENTER></H2>
</a>

<p>Hybrid MBRs are often used on boot disks with multiple OSes, and so the
issue of bootability is an important one. Unfortunately, this is an area
that's even more poorly documented than the murky area of booting GPT disks
generally. I've done some experimenting, but I don't claim to have all the
answers. Some information I consider reliable includes the following:</p>

<UL>

<LI><b><a href="http://www.gnu.org/software/grub/grub-2.en.html">GRUB
    Legacy and GRUB 2</a></b>&mdash;These workhorse boot loaders, which are
    very popular on Linux, work well with both MBR and GPT disks (although
    you need a patched GRUB 0.97 or GRUB2 for GPT support). They appear to
    be very fussy about hybrid MBRs, though. In particular, if the EFI GPT
    (0xEE) partition resides anywhere but in the first position of the MBR
    partition table, these boot loaders treat the disk as if it were
    MBR-only. The likely result is that some or all of your OSes won't
    boot. For this reason, if you expect to use GRUB or GRUB2 with a hybrid
    MBR, I suggest you place the EFI GPT partition first in the partition
    table. You should also be aware that, when you place the EFI GPT
    partition first in the MBR table, you should use the GPT partition
    numbers for your hybrid partitions, even if the OSes they contain are
    GPT-unaware. These identifiers are for the use of GRUB/GRUB2 only. Once
    the OS boots, it will read the MBR and figure out its own way of
    referring to partitions. The latest versions of GRUB 2 include an
    optional partition table type specifier in device identifiers, as in
    <tt>(hd0,gpt3)</tt> or <tt>(hd1,mbr2)</tt>. I haven't investigated this
    in detail, but I'm guessing these enable you to specify a partition
    unambiguously using either its GPT or its MBR partition number.</LI>

<LI><b><a href="http://chameleon.osx86.hu">Chameleon</a></b>&mdash;This is
    a popular boot loader among those who run macOS on standard PC
    hardware. It tends to boot straight through to Windows, however, if you
    mark a Windows partition as bootable in the MBR. Fortunately, Windows
    (at least, Windows 7, and I'm told anything in the NT family) is able
    to boot without this flag set, so the solution is simple: Don't set the
    bootable flag in the MBR, or remove it if it's already set.</LI>

<LI><b><a
    href="http://msdn.microsoft.com/en-us/library/aa362639(VS.85).aspx?ppud=4">Windows
    MBR & BCD</a></b>&mdash;Windows' default method of booting is as old as
    the MBR hills: It involves an MBR boot loader that in turn loads the
    boot sector of the partition that's marked as active in the MBR. This
    boot sector then loads additional boot files, which are known today as
    the Boot Configuration Data (BCD). This configuration works just fine
    on a hybrid MBR, provided that you only want to boot one partition and
    it's marked as active. Some third-party utilities, such as <a
    href="http://neosmart.net/dl.php?id=1">EasyBCD,</a> extend this system
    by enabling BCD to boot other partitions. I don't know if any such
    tools enable booting GPT-based OSes, though.</LI>

<LI><b><a href="http://refit.sourceforge.net">rEFIt</a> and <a
    href="https://www.rodsbooks.com/refind/">rEFInd</a></b>&mdash;These boot
    managers are EFI-only tools, although they can chainload to BIOS-mode
    OSes in some circumstances. They both rely on the underlying EFI to
    interpret partitions, and EFIs normally ignore the MBR side of hybrid
    MBR disks. I have not done extensive tests to determine if there are any
    notable quirks with unusual hybrid MBR configurations; and any such
    quirks could be implementation-specific in any event, and therefore vary
    from one computer to another.</LI>

</UL>

<p>Unfortunately, the non-standard nature of hybrid MBRs means that you'll
be venturing into uncharted territory when you use this type of
configuration with most tools. Generally speaking, macOS users seem to
be the most experienced with such setups, thanks to Apple's Boot Camp and
the OSx86 (macOS on stock PC) communities.</p>

<p>Most OSes try to install their own boot loaders to the MBR when you
install them, at least on BIOS-based computers. Thus, when you install
multiple OSes, you often end up overwriting the earlier OSes' boot
loaders. You can generally use GRUB or some other flexible boot loader in
the MBR to redirect the boot process to any OS; however, sometimes this
doesn't work. One trick that can be helpful is to back up the MBR, or at
least its boot code (the first 440 bytes) after every OS installation. In
Linux, you can use <tt>dd</tt> to do the job:</p>

<pre class="listing">
# <b>dd if=/dev/sda of=/boot/sda-mbr-backup-1.img bs=512 count=1</b>
</pre>

<p>This command backs up the entire MBR. If you change <tt>bs=512</tt> to
<tt>bs=440</tt>, only the MBR's boot loader will be backed up, which could
be preferable if you want to restore the boot loader later without
affecting the MBR partition table. With a backup of the MBR's boot loader
from after each OS installation in hand, you can try redirecting the boot
process through such a backup file, if you can't find a more direct way to
boot the OS. In GRUB, the configuration would look like this:</p>

<pre class="listing">
title OpenSolaris 2008.11 captured MBR
        root (hd0,1)
        chainloader (hd1,4)/hda-solaris-mbr.img
</pre>

<p>This example is taken from an actual OpenSolaris installation on one of
my computers, although the installation in question doesn't use a hybrid
MBR. The details will vary with boot loaders other than GRUB, of
course.</p>

<H2 ALIGN="CENTER"><CENTER>Hybrid MBR Strategies</CENTER></H2>

<p>As I've said before, hybrid MBRs are clunky, ugly, and dangerous. If at
all possible, I recommend you avoid them. If possible, use two disks rather
than a hybrid MBR. Place your GPT-unaware OSes on the MBR disk and use GPT
on the other disk. Recent versions of Windows (Vista and later, and some
earlier versions, depending on platform) can read GPT disks just fine once
booted; they just can't boot from GPT. This fact gives you an "out" if you
need to use large disks or employ GPT for another OS's benefit, since you
can boot Windows from an MBR disk and store data on a separate GPT disk.
Some RAID controllers enable you to configure a RAID array as two or more
virtual disks, which you can then partition using MBR and GPT. In some
cases, using virtualization software, such as <a
href="https://www.virtualbox.org/">VirtualBox</a> or <a
href="https://www.vmware.com/products/personal-desktop-virtualization.html">VMware
Workstation or Fusion,</a> can be better and safer than dual-booting your
OSes.</p>

<p>Sometimes, though, you might really have no alternative but to use a
hybrid MBR. This might be necessary on a laptop computer on which you want
to install lots of OSes, for instance. In such cases, I recommend you treat
your GPT configuration as the standard one. If possible, create the initial
partitions using GPT fdisk or some other GPT partitioning tool; converting
from MBR to GPT and then hybridizing presents more opportunities for
problems to crop up. (On the other hand, an MBR partitioning tool is more
likely to create partitions on cylinder boundaries, which some OSes may
appreciate.) If you run into problems or need to repartition, restore a
standard GPT protective MBR (using the <tt>n</tt> option on GPT fdisk's
experts' menu), do whatever you need to do to your partitions, and then
create a fresh hybrid MBR.</p>

<p>In my experience, Windows doesn't react well to changes in its
partitions. (This has been true for many years; it's not a GPT-specific
issue.) Thus, if possible you should install Windows <em>after</em> you
create hybrid MBR partitions for it. Plan to re-install your MBR-based boot
loader after installing Windows. On the other hand, Windows will create new
partitions for itself if it doesn't see all the partitions it needs, so you
must be careful to create all the partitions that Windows requires before
you begin, lest it create MBR partitions that overlap with GPT
partitions.</p>

<p>On a sub-2 TiB disk, place the partitions you must access via MBR at the
<em>end</em> of the disk, to enable the EFI GPT (0xEE) partition to protect
the non-MBR partitions. If you can keep your hybridized partitions
contiguous, and numbered at just 1 or 2, you'll also be able to create a
second protective partition to keep the secondary GPT data safe from
meddling by GPT-unaware utilities.</p>

<p>On an over-2 TiB disk, having just 1 or 2 hybridized partitions becomes
even more important, since you'll then be able to create a second
protective partition after those partitions. Alternatively, you could place
your to-be-hybridized partitions so that they're contiguous and terminate
as close as possible to, but before, the 2 TiB mark. This layout will
protect the preceding GPT partitions (via the 0xEE MBR partition), and the
subsequent GPT partitions will be protected by virtue of falling after the
MBR's 2 TiB limit.</p>

<p>Discussion forums are filled with posts about hybrid MBRs, mostly from
people using Boot Camp with macOS. If you run into problems, try posting to
such a forum. Although I may be able to help, I minimize my own use of
hybrid MBRs, and my impression is that hybrid MBR problems can be quite
quirky and configuration-dependent, so your best bet in getting help is to
post your problems in a well-read forum.</p>

<H2 ALIGN="CENTER"><CENTER>The Other Hybrid MBR</CENTER></H2>

<p>The preceding describes hybrid MBRs as they are commonly used in 2009
and early 2010, with updates as late as 2019. <a
href="http://www.t13.org/Documents/UploadedDocuments/docs2010/e09127r3-EDD-4_Hybrid_MBR_boot_code_annex.pdf">This
PDF document,</a> however, describes an entirely different type of hybrid
MBR. This type of hybrid MBR is basically an MBR partition scheme embedded
within a GPT partition. The idea is that GPT-unaware OSes could, with the
help of a modified boot loader, boot from the GPT partition as if it were a
hard disk. As written, this document only mentions in passing the MBR
Partition Scheme (GPT fdisk code EF01) that's already defined; instead, it
emphasizes setting a new attribute bit.</p>

<p>To the best of my knowledge, no boot loader or OS currently implements
this alternative type of "hybrid MBR" configuration. If you hear of such an
implementation, I'd be interested in learning about it.</p>

<p><a href="repairing.html">Go on</a> to "Repairing GPT Disks"</p>

<p><a href="index.html">Return</a> to "GPT fdisk" main page</p>

<HR>

<p>If you have problems with or comments about this web page, please
e-mail me at <a href="mailto:rodsmith@rodsbooks.com">
rodsmith@rodsbooks.com.</a>  Thanks.</p>

<p><a href="http://www.rodsbooks.com/">Return</a> to my main web page.</p>

</BODY>
</HTML>
